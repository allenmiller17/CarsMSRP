---
title: "6372 Auto Project"
author: "Justin Ehly"
date: "1/18/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
### Libraries ###
library(car)
library(magrittr)
library(tibble)
library(naniar)
library(VIM)
library(FactoMineR)
library(purrr)
library(gdata)
library(glmnet)
library(leaps)
library(caret)
library(tidyverse)
library(stringr)
library(dplyr)
```

```{r data download data}
### Download Data and Clean ###

# teammates that fork this code chunk, be sure to set
# your working directory to the DataSet folder in your your github folder
#setwd("C:/Users/justi/Documents/GitHub/6372-Auto-Pricing-Project/DataSet")
setwd(choose.dir()) #this only works on a windows machine

auto_data <- read.csv("data1.csv")
view(auto_data)

summary(auto_data)
str(auto_data)
autos <- auto_data
```



```{r clean data}
#############################

###    Clean the dataset  ###

#############################

autos <- rename(autos, mpg.highway = highway.MPG, mpg.city = city.mpg)
# replace all chr with factors
autos[sapply(autos,is.character)] <- lapply(autos[sapply(autos,is.character)], as.factor)
autos$Year <- as.factor(autos$Year) # make Year into a factor
autos$Number.of.Doors <- as.factor(autos$Number.of.Doors) # change to factor

view(autos)


### Audi A6 sure does have an awesome mpg.highway - should be 34 not 354 ###
autos$mpg.highway[1120] <- 34

# create an average mpg column
autos$MPG <- (autos$mpg.city+autos$mpg.highway) / 2
autos <- autos[,-c(13,14)]

##### Look for any NAs in the data set ####
sapply(autos, function(x) sum(x %in% common_na_strings)) # missing values using other than NA
sapply(autos, function(x) sum(x %in% common_na_numbers)) # missing values using other than NA
res<-summary(aggr(autos)) # visual graph of missing values
res #summary of missing values by variable name

#Fiat 500e - electric so no cylinders
autos$Engine.HP[c(540:542)] <- 111 

#2017 Continental
autos[c(2906:2909),]
autos$Engine.HP[c(2906:2909)] <- 400 

#2017 Escape
autos[c(4204:4207),]
autos$Engine.HP[c(4204:4207)] <- 179 

#2013-2014 Fit EV
autos[c(4706,4707),]
autos$Engine.HP[c(4706,4707)] <- 123

#2015 Ford Focus EV 143hp
autos[c(4786,4790,4799),]
autos$Engine.HP[c(4786,4790,4799)] <- 143

#2005 Ford Freestar only vans above $29k have 201 HP
autos[c(4915:4928),] %>% select(Engine.HP,MPG, MSRP) %>% arrange(MSRP)
autos[c(4915:4928),] %>% select(Engine.HP,MPG, MSRP) %>% arrange(MPG)
autos$Engine.HP[c(4915:4918)] <- 193
autos$Engine.HP[c(4919:4920)] <- 201

# 2014 Mitsubishi i-MiEV
autos$Engine.HP[5779] <- 66

# 2015-2016 Kia Soul EV
autos$Engine.HP[c(9851:9855)] <- 109

#2013-2014 Toyota Rav4 EV
autos$Engine.HP[c(8375:8376)] <- 154

#Telsa Model S missing values
autos %>% filter(Make == "Tesla")

tesla <- read.csv("tesla.csv")
#view(tesla)

# mass replace tesla missing values since they were mostly all independent
for(i in 6922:6939){autos$Engine.HP[i] <- tesla$Engine.HP[i-(6921)]}
for(i in 6922:6939){autos$Number.of.Doors[i] <- tesla$Number.of.Doors[i-(6921)]}
#view(autos)

# 2017 Lincoln MKZ - all FWD have 240hp
autos$Engine.HP[c(6909,6911,6917,6919)] <- 240

# 2015 Mercedes M-Class Diesel
autos$Engine.HP[6579] <- 200

#2014-2016 Nissan Leaf - all 107 hp
autos$Engine.HP[c(6386:6395)] <- 107

#### Work on missing cylinders 
missingCyl <- which (is.na(autos$Engine.Cylinders))
#write.csv(autos[missingCyl,],"MissingCyl.csv")
#view(autos[missingCyl,])
#change electric cars to 'e' for cylinders since they don't have any
autos$Engine.Cylinders <- ifelse(autos$Engine.Fuel.Type == 'electric','e',autos$Engine.Cylinders)
#change the mazda RX cars to 'r' for rotary engine since they don't have cylinders
autos$Engine.Cylinders[c(8696:8715)] <- 'r'

# any remaining missing values?
sapply(autos, function(x) sum(x %in% common_na_strings))
sapply(autos, function(x) sum(x %in% common_na_numbers))

# the software seems to think there is 1 value missing for number.of.doors
autos[which(is.na(autos$Number.of.Doors)),]
# 2- door ferrari ff
autos$Number.of.Doors[which(is.na(autos$Number.of.Doors))] <-2


summary(autos)
str(autos)



# Engine.Fuel.Type - suzuki is missing
autos$Engine.Fuel.Type[c(11322:11324)] <- 'regular unleaded'

# All that is left now is to either predict or imput the Market.Category - 
# rather, let's follow the path of the directions and just create and "exotic" attribute
exotic <- c('Ferrari','Alfa Romeo','McLaren', 'Maybach', 'Porsche', 
            'Bentley', 'Lamborghini', 'Spyker', 'Rolls-Royce', 'Maserati',
            'Aston Martin', 'Lotus', 'Bugatti')
for(i in 1:length(autos$Make)){
  ifelse(autos$Make[i] %in% exotic,autos$Exotic[i] <- 'Exotic', autos$Exotic[i] <- 'Not Exotic')
}
autos$Exotic <- as.factor(autos$Exotic)
str(autos)
autos$Market.Category <- NULL #remove this unused column, it's overly complex

autos$Engine.HP <- as.integer(autos$Engine.HP)

#2015 Impala duel-fuel - since only a 30hp difference, might as well use the higher hp

autos[c(5826,5831, 5832, 5834, 5840, 5841),]
autos$Engine.HP[c(5826,5831,5832,5834,5840, 5841)] <- 260



str(autos)
# replace all chr with factors
autos[sapply(autos,is.character)] <- lapply(autos[sapply(autos,is.character)], as.factor)
autos$Year <- as.factor(autos$Year) # make Year into a factor
autos$Number.of.Doors <- as.factor(autos$Number.of.Doors) # change to factor


str(autos)
sapply(autos, function(x) sum(is.na(x)))

sapply(autos, function(x) sum(toupper(x) == toupper("Unknown")))
# Transmission Types has 19 missing values
autos$Transmission.Type[c(1290:1291)] <- "AUTOMATIC" #Oldsmobile Achieva
autos$Transmission.Type[c(4692:4694)] <- "AUTOMATIC" #Pontiac Firebird with 15/23 MPG and V8
autos$Transmission.Type[c(6159,6161,6166,6175)] <- "AUTOMATIC" #1999/2000 GMC Jimmy
autos$Transmission.Type[c(6367,6369)] <- "AUTOMATIC" #1993 Chrysler LeBaron
autos$Transmission.Type[c(8043,8044,8047:8050,8052,8054)] <- "AUTOMATIC" #1991 Dodge Ram 150


view(autos)
sapply(autos, function(x) sum(is.na(x)))



```


```{r objective 1 EDA}
####################

### EDA  ###########

####################

library(ggplot2)
summary(autos) #summary of main autos df


### Make ###
t(aggregate(Popularity~Make,data=auto_data,min)) #appears each make has a specific popularity
auto_data %>% ggplot(aes(x=Make, y=mean(Popularity))) +
  geom_col() +
  labs(title = "Mean Popularity Score vs Make", 
       y = "Mean Popularity", 
       x = "Make") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


### Model ###
t(aggregate(Popularity~Model,data=autos,summary))
autos %>% ggplot(aes(x=Model, y=mean(Popularity))) +
  geom_col() +
  labs(title = "Mean Popularity Score vs Model", 
       y = "Mean Popularity", 
       x = "Model") + theme_classic()

### Year ###
t(aggregate(Popularity~Year, data=autos, summary))
t(aggregate(Popularity~Year, data=autos, mean))



###  Engine.Fuel.Type ###
t(aggregate(Popularity~Engine.Fuel.Type, data=autos, summary))
t(aggregate(Popularity~Engine.Fuel.Type, data=autos, mean))
autos %>% ggplot(aes(x=Engine.Fuel.Type, y=mean(Popularity))) +
  geom_col() +
  labs(title = "Mean Popularity Score vs Engine Fuel Type", 
       y = "Mean Popularity", 
       x = "Engine Fuel Type") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

### Engine.HP ###
t(aggregate(Popularity~Engine.HP, data=autos, summary))
t(aggregate(Popularity~Engine.HP, data=autos, mean))
autos %>% ggplot(aes(x=Engine.HP, y=mean(Popularity))) +
  geom_col() +
  labs(title = "Popularity Score vs Engine HP", 
       y = "Popularity", 
       x = "Engine HP") + theme_classic()
# Interesting relationship here - note that mean is used to prevent the software from adding up the popularity scores vs just reporting on which one has the actual most popularity

### Engine.Cylinders ###
t(aggregate(Popularity~Engine.Cylinders, data=autos, summary))
autos %>% ggplot(aes(x=Engine.Cylinders, y=mean(Popularity))) +
  geom_col() +
  labs(title = "Popularity Score vs Engine Cylinders", 
       y = "Popularity", 
       x = "Engine Cylinders") + theme_classic()
# Interesting relationship here - note that mean is used to prevent the software from adding up the popularity scores vs just reporting on which one has the actual most popularity

### Transmission.Type ###
t(aggregate(Popularity~Transmission.Type , data=autos, summary))
autos %>% ggplot(aes(x=Engine.Cylinders, y=mean(Popularity))) +
  geom_col() +
  labs(title = "Popularity Score vs Engine Cylinders", 
       y = "Popularity", 
       x = "Engine Cylinders") + theme_classic()

### driven.wheels ###
t(aggregate(Popularity~Driven_Wheels , data=autos, summary))
autos %>% ggplot(aes(x=Driven_Wheels, y=mean(Popularity))) +
  geom_col() +
  labs(title = "Popularity Score vs Driven Wheels", 
       y = "Popularity", 
       x = "Wheel Drive") + theme_classic()


### Number.of.Doors ###
t(aggregate(Popularity~Number.of.Doors , data=autos, summary))
t(aggregate(Popularity~Number.of.Doors , data=autos, mean))
autos %>% ggplot(aes(x=Number.of.Doors, y=mean(Popularity))) +
  geom_col() +
  labs(title = "Mean Popularity Score vs Number of Doors", 
       y = "Mean Popularity", 
       x = "Number of Doors") + theme_classic()


### Vehicle.Size  ###
t(aggregate(Popularity~Vehicle.Size , data=autos, summary))
t(aggregate(Popularity~Vehicle.Size , data=autos, mean))
autos %>% ggplot(aes(x=Vehicle.Size, y=mean(Popularity))) +
  geom_col() +
  labs(title = "Popularity Score vs Vehicle Size", 
       y = "Popularity", 
       x = "Vehicle Size") + theme_classic()


###  Vehicle.Style ###
t(aggregate(Popularity~Vehicle.Style , data=autos, summary))

autos %>% ggplot(aes(x=Vehicle.Style, y=mean(Popularity))) +
  geom_col() +
  labs(title = "Popularity Score vs Vehicle Style", 
       y = "Popularity", 
       x = "Vehicle Style") + theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


### MPG ###
t(aggregate(Popularity~MPG, data=autos, summary))

autos %>% ggplot(aes(x=MPG, y=mean(Popularity))) +
  geom_col() +
  labs(title = "Mean Popularity Score vs Highway MPG", 
       y = "Mean Popularity", 
       x = "Average MPG") + theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


summary(autos)
names(autos)
str(autos)
# rearrange the order of variables to put response "MSRP" first
autos <- autos[,c(13,1:12,14,15)]
str(autos)

# look at the matrix plots vs MSRP
pairs(autos[,c(1:6)]) 
pairs(autos[,c(1,7:11)])
pairs(autos[,c(1,12:13)])
pairs(autos[,c(1,6,13,14)]) #MSRP ~ HP + Popularity, MPG
 


```

```{r clean up the categorical variables}
########################################

### Clean up categorical variables #####

########################################

block_saver <- autos # in case I accidentally mess up the dataframe, I can restart here without having to start all the way from the beginning

names(autos)


autos1 <- autos[,-c(2:4,10)]
names(autos1)
str(autos1)
mod.fit <- aov(MSRP~., data=autos1)
summary(mod.fit)
# MPG(pvalue = 0.107) cfrom f tests
autos1 <- autos1[,-c(10)]

# test within the categorical variables

test.lm <- lm(MSRP~., data=autos1)
summary(test.lm)
vif(test.lm) # error with aliased coefficients, let's remove make and model for now


##################

### Fuel Types ###

##################
# test for differences in fuel types related to MSRP
test_lm <- lm(MSRP~Engine.Fuel.Type, data=autos1)
summary(test_lm)

# Testing for unleaded differences
test_lm <- autos1 %>% filter(grepl("unleaded",Engine.Fuel.Type)) %>%
  lm(MSRP~Engine.Fuel.Type, data=.)
summary(test_lm)
  
autos1$new.fuel <- as.factor(autos1$Engine.Fuel.Type)
autos1$new.fuel <- as.factor(autos1$new.fuel)

autos1$new.fuel <- str_replace_all(autos1$new.fuel, "premium unleaded \\(recommended\\)", "regular unleaded")
unique(autos1$new.fuel)
test_lm <- lm(MSRP~new.fuel, data=autos1)
summary(test_lm)

autos1$new.fuel <- str_replace_all(autos1$new.fuel, "flex-fuel \\(premium unleaded recommended\\/E85\\)", "flex-fuel (unleaded/E85)")
test_lm <- lm(MSRP~new.fuel, data=autos1)
summary(test_lm)

autos1$new.fuel <- str_replace_all(autos1$new.fuel, "flex-fuel \\(unleaded\\/E85\\)", "flex-fuel")
autos1$new.fuel <- str_replace_all(autos1$new.fuel, "flex-fuel \\(unleaded\\/natural gas\\)", "flex-fuel")
test_lm <- lm(MSRP~new.fuel, data=autos1)
summary(test_lm)

autos1$new.fuel <- case_when(
  autos1$new.fuel == "natural gas" ~ "alternative",
  autos1$new.fuel == "flex-fuel" ~ "alternative",
  autos1$new.fuel == "diesel" ~ "alternative",
  autos1$new.fuel == "electric" ~ "alternative",
  TRUE~autos1$new.fuel)

autos1$new.fuel <- as.factor(autos1$new.fuel)
levels(autos1$new.fuel)

autos1$Engine.Fuel.Type <- autos1$new.fuel
levels(autos1$Engine.Fuel.Type)
str(autos1)
names(autos1)
# remove new.fuel
autos1 <- autos1[,-13]


###### New LM test ##########

test_lm <- lm(MSRP~., data=autos1)
summary(test_lm)
names(autos1)

# remove Engine.HP b/c insignificant pvalue = 0.425
autos1 <- autos1[,-2]

###### New LM test ##########

test_lm <- lm(MSRP~., data=autos1)
summary(test_lm)

#########################

### Transmission  #######

#########################

# Transmission Direct Drive appears insig pvalue =.414
levels(autos1$Transmission.Type)

autos1$Transmission.Type <- str_replace_all(autos1$Transmission.Type, "AUTOMATED_MANUAL", "n")
autos1$Transmission.Type <- str_replace_all(autos1$Transmission.Type, "DIRECT_DRIVE", "n")
autos1$Transmission.Type <- str_replace_all(autos1$Transmission.Type, "n", "AUTO-MANUAL-OR-DIRECT-DRIVE")

autos1$Transmission.Type <- as.factor(autos1$Transmission.Type)

### new LM test ###

test_lm <- lm(MSRP~., data=autos1)
summary(test_lm)

############################

### Driven Wheels ##########

############################

# Driven Wheels
autos1$Driven_Wheels <- str_replace_all(autos1$Driven_Wheels, "four wheel drive", "zzz")
autos1$Driven_Wheels <- str_replace_all(autos1$Driven_Wheels, "all wheel drive", "zzz")
autos1$Driven_Wheels <- str_replace_all(autos1$Driven_Wheels, "front wheel drive", "zzz")
autos1$Driven_Wheels <- str_replace_all(autos1$Driven_Wheels, "zzz", "all or 4 wheel drive")
autos1$Driven_Wheels <- as.factor(autos1$Driven_Wheels)
levels(autos1$Driven_Wheels)

test_lm <- lm(MSRP~., data=autos1)
summary(test_lm)

#############################

### Vehicle Size ############

#############################

# vehicle size large pvlaue = 0.3796
autos1$Vehicle.Size <- str_replace_all(autos1$Vehicle.Size, "Compact", "Not-Midsize")
autos1$Vehicle.Size <- str_replace_all(autos1$Vehicle.Size, "Large", "Not-Midsize")
autos1$Vehicle.Size <- as.factor(autos1$Vehicle.Size)
levels(autos1$Vehicle.Size)

### new lm test ###

test_lm <- lm(MSRP~., data=autos1)
summary(test_lm)

test_lm <- lm(MSRP~Vehicle.Style, data=autos1)
summary(test_lm)
#autos1$Vehicle.Style <- autos$Vehicle.Style
autos1$Vehicle.Style <- as.character(autos1$Vehicle.Style)
autos1$Vehicle.Style <- case_when(
  autos1$Vehicle.Style == "2dr SUV" ~ "SUV",
  autos1$Vehicle.Style == "4dr SUV" ~ "SUV",
  autos1$Vehicle.Style == "Convertible SUV" ~ "SUV",
  autos1$Vehicle.Style == "4dr Hatchback" ~ "Sedan",
  autos1$Vehicle.Style == "Extended Cab Pickup" ~ "Pickup",
  autos1$Vehicle.Style == "Regular Cab Pickup" ~ "Pickup",
  autos1$Vehicle.Style == "Crew Cab Pickup" ~ "Pickup",
  autos1$Vehicle.Style == "Cargo Minivan" ~ "Other",
  autos1$Vehicle.Style == "Cargo Van" ~ "Other",
  autos$Vehicle.Style == "2dr Hatchback" ~ "Other",
  TRUE ~ autos1$Vehicle.Style
)
autos1$Vehicle.Style <- as.factor(autos1$Vehicle.Style)
levels(autos1$Vehicle.Style)

### Lm test
test_lm <- lm(MSRP~., data=autos1)
summary(test_lm)
vif(test_lm) # all vif's look good around 1


autos <- autos1
str(autos)

```

```{r create 3 data sets}
##############################

#### Create 3 Data Sets  #####

##############################
set.seed(123)
spec = c(train = .8, test = .1, validate = .1) #set the split percentages 80/10/10

ind = sample(cut(
  seq(nrow(autos)), 
  nrow(autos)*cumsum(c(0,spec)),
  labels = names(spec)
))

autosplits = split(autos, ind)

# check results
sapply(autosplits, nrow)/nrow(autos)
#     train       test   validate 
# 0.79998321 0.09996643 0.10005036 

# assign simple common names to each dataset 
train <- autosplits$train
test <- autosplits$test
validate <- autosplits$validate

str(train)
str(test)
str(validate)


```

Objective 1: Display the ability to build regression models using the skills and discussions from Unit 1 and 2 with the purpose of identifying key relationships and interpreting those relationships.  A key question of interest that must be addressed in this analysis is the importance of the “Popularity” variable.  While the details of this variable are vague, it was created from social media, and the “higher ups” are curious how much general popularity can play a role in the retail price of a vehicle.   


```{r forward regression}
reg.fwd <- regsubsets(MSRP ~ .,data=train, method="forward")


#Really handy predict function
predict.regsubsets <- function (object , newdata ,id ,...)
  {
  form=as.formula (object$call [[2]])
  mat=model.matrix(form ,newdata )
  coefi=coef(object ,id=id)
  xvars=names(coefi)
  mat[,xvars]%*%coefi
  }


testASE <- c()
#note my index is to 100 since that what I set it in regsubsets
for (i in 1:reg.fwd$nvmax){
  predictions <- predict.regsubsets(object=reg.fwd, newdata=test, id=i) 
  testASE[i]  <- mean((test$MSRP - predictions)^2)
}
par(mfrow=c(1,1))
plot(1:100,testASE,type="l", xlab="# of predictors", ylab="test vs train ASE")
index <- which(testASE == min(testASE))
points(index, testASE[index], col="red", pch=10)
rss <- summary(reg.fwd)$rss
lines(1:101,rss/1191,lty=3,col="blue")  #Dividing by 1191 since ASE=RSS/sample size

```

```{r model assumptions}

reg.final = regsubsets(Popularity~.,data=Subset,method="forward",nvmax=4)
coef(reg.final,3) #coefficients of the model

final.model <- lm(mpg ~ cylinders + weight + year, data=Subset)
summary(final.model)

# Check the model assumptions to make sure everything is valid.  
par(mfrow=c(2,2))
plot(final.model$fitted.values, Subset$mpg)
```


```{r fit some models LASSO}

#Formatting data for GLM net
x= sparse.model.matrix(~., train[,c(1:13,15,16)]) 
y <- train$Popularity

xtest <- sparse.model.matrix(~., test[,c(1:13,15,16)])
ytest <- test$Popularity

#kept getting errors and a sparse matrix was suggested in stackoverflow 
# https://stackoverflow.com/questions/29015282/predict-function-error-for-probabilities-in-glmnet


grid=10^seq(10,-2, length =100)
lasso.mod=glmnet(x,y,alpha=1, lambda =grid)

cv.out=cv.glmnet(x,y,alpha=1) #alpha=1 performs LASSO
plot(cv.out)
bestlambda <- cv.out$lambda.min  #Optimal penalty parameter.  You can make this call visually.
lasso.pred <- predict(lasso.mod, newx=xtest, s=bestlambda)

testMSE_LASSO<-mean((ytest-lasso.pred)^2)
testMSE_LASSO

coef(lasso.mod,s=bestlambda)


```

```